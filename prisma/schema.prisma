// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // relationMode = "prisma"

}

// ===================== ENUMS =====================

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum TransitionCondition {
  SUCCESS
  FAILURE
}
enum UploadStatus {
  ACTIVE
  COMPLETED
  EXPIRED
  ABORTED
}
enum CommentStatus {
  OPEN
  RESOLVED
}
enum CommentPriority {
  NONE
  LOW
  MEDIUM
  HIGH
}

enum AccessType {
  PUBLIC       // Anyone with link
  PASSWORD     // Requires password
}

enum SocialPlatform {
  TWITTER
  INSTAGRAM
  FACEBOOK
  LINKEDIN
  TIKTOK
  YOUTUBE
  PINTEREST
  REDDIT
  BLUESKY
  THREADS
  GOOGLE_BUSINESS
}

enum PostStatus {
  DRAFT          
  SCHEDULED     
  PUBLISHING    
  PUBLISHED      
  FAILED         
  CANCELLED      
  DELETED        // Deleted from platform (history kept)
}

enum DocumentType {
  PDF
  IMAGE       // PNG, JPG, JPEG, GIF, WEBP
  DOCUMENT    // DOCX, DOC, ODT
  SPREADSHEET // XLSX, XLS, CSV
  TEXT        // TXT, MD
  PRESENTATION // PPTX, PPT
  OTHER
}

enum AssetType {
  VIDEO
  DOCUMENT
}

enum VisibilityScope {
  ROLE      // Visible to specific roles
  EMPLOYEE  // Visible to specific employees
  COMPANY   // Visible to entire company
}


// ===================== CORE MODELS =====================

model Company { 
  id                      String       @id @default(cuid())
  name                    String       @db.VarChar(255)
  domain                  String?      @unique @db.VarChar(255)
  description             String?      @db.Text
  email                   String?      @db.VarChar(255)
  mobile                  String?      @db.VarChar(50)
  logoUrl                 String?

  employees               Employee[]
  departments             Department[]
  roles                   Role[]
  teams                   Team[]
  campaigns               Campaign[]

  flowchains              FlowChain[]
  permissionCombos        PermissionCombo[]
  videoCollections        VideoCollection[]
  lateProfile             LateProfile?    
  socialAccounts          SocialAccount[] 
  socialPosts             SocialPost[]    
  assetVisibility         AssetVisibility[]
  notificationPreference  NotificationPreference?
  slackIntegration        SlackIntegration?
  teamsIntegration        TeamsIntegration?
  emailIntegration        EmailIntegration?
  notificationsLog        NotificationLog[]
  videos                  Video[]
  documents               Document[]



  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // Indexes for performance
  @@index([name])
  @@index([domain])
  @@index([updatedAt(sort: Desc)])
  @@index([id, updatedAt(sort: Desc)])
  @@index([id, name])
  @@unique([name, id])
}

model Department {
  id        String  @id @default(cuid())
  name      String  @db.VarChar(255)
  companyId String
  parentId  String?
  
  // Relations
  company   Company      @relation(fields: [companyId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  parent    Department?  @relation("SubDepartments", fields: [parentId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  children  Department[] @relation("SubDepartments")
  employees Employee[]
  
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // Indexes
  @@index([companyId])
  @@index([parentId])
  @@index([companyId, name])
  @@unique([name, companyId])
}

model Role {
  id          String  @id @default(cuid())
  name        String  @db.VarChar(255)
  description String? @db.Text
  companyId   String
  parentId    String?
  
  // Relations
  company             Company              @relation(fields: [companyId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  parent              Role?                @relation("RoleHierarchy", fields: [parentId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  children            Role[]               @relation("RoleHierarchy")
  employees           Employee[]
  permissions         RolePermission[]
  FlowStep            FlowStep[]
  campaignAssignments CampaignAssignment[]
  campaignSchedules   CampaignSchedule[]
  assetVisibility     AssetVisibility[]

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // Indexes
  @@index([companyId])
  @@index([parentId])
  @@index([companyId, name])
  @@unique([name, companyId])
}

model Permission {
  id          String  @id @default(cuid())
  name        String  @unique @db.VarChar(255)
  description String? @db.Text
  group       String? @db.VarChar(100)
  
  // Relations
  roles  RolePermission[]
  combos ComboPermission[]
  
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // Indexes
  @@index([name])
  @@index([group])
}

model RolePermission {
  roleId       String
  permissionId String
  
  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  
  createdAt DateTime @default(now()) @db.Timestamptz(3)

  @@id([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model Employee {
  id                        String         @id @default(cuid())
  firstName                 String         @db.VarChar(255)
  lastName                  String         @db.VarChar(255)
  email                     String         @unique @db.VarChar(255)
  passwordHash              String         @db.VarChar(255)
  status                    EmployeeStatus @default(ACTIVE)
  isAdmin                   Boolean        @default(false) @map("is_admin")
  lastLogin                 DateTime?      @db.Timestamptz(3)
  companyId                 String
  roleId                    String?
  departmentId              String?
  avatarUrl                 String?
  // Relations
  company                   Company              @relation(fields: [companyId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  role                      Role?                @relation(fields: [roleId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  department                Department?          @relation(fields: [departmentId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  campaigns                 Campaign[]
  teams                     Team[]               @relation("TeamMembers")
  ownedTeams                Team[]               @relation("AdminTeams")
  campaignAssignments       CampaignAssignment[]
  uploadedVideos            Video[]              @relation("VideoUploader")
  videoVersions             VideoVersion[]       @relation("VersionUploader")
  uploadSessions            UploadSession[]      @relation("UploadSessions")
  compressionJobs           CompressionJob[]     @relation("CompressionRequests")
  videoComments             Comment[]  @relation("VideoComments")
  resolvedComments          Comment[]  @relation("CommentResolver")
  managerId                 String?
  manager                   Employee?    @relation("EmployeeHierarchy", fields: [managerId], references: [id], onDelete: SetNull)
  subordinates              Employee[]   @relation("EmployeeHierarchy")
  createdCollections        VideoCollection[] @relation("CollectionCreator")
  assetVisibility           AssetVisibility[]
  uploadedDocuments         Document[]           @relation("DocumentUploader")
  documentVersions          DocumentVersion[]    @relation("DocumentVersionUploader")
  documentComments          DocumentComment[]    @relation("DocumentComments")
  resolvedDocumentComments  DocumentComment[]  @relation("DocumentCommentResolver")
  
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // Indexes for common queries
  @@index([email])
  @@index([companyId])
  @@index([roleId])
  @@index([departmentId])
  @@index([companyId, status])
  @@index([companyId, email])
  @@index([lastLogin(sort: Desc)])
}

model Team {
  id        String @id @default(cuid())
  name      String @db.VarChar(255)
  adminId   String
  companyId String
  
  // Relations
  company   Company    @relation(fields: [companyId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  teamAdmin Employee   @relation("AdminTeams", fields: [adminId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  members   Employee[] @relation("TeamMembers")
  campaigns Campaign[]
  
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // Indexes
  @@index([companyId])
  @@index([adminId])
}



model FlowChain {
  id          String  @id @default(cuid())
  name        String  @db.VarChar(255)
  description String? @db.Text
  companyId   String
  
  // Relations
  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  steps         FlowStep[]
  campaignFlows CampaignFlow[]
  
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // Indexes
  @@index([companyId])
  @@index([companyId, name])
  @@index([updatedAt(sort: Desc)])
}

model FlowStep {
  id          String  @id @default(cuid())
  name        String  @db.VarChar(255)
  description String? @db.Text
  chainId     String
  roleId      String?
  
  // Relations
  chain         FlowChain        @relation(fields: [chainId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  role          Role?            @relation(fields: [roleId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  nextSteps     FlowTransition[] @relation("NextStepRelation")
  previousSteps FlowTransition[] @relation("PrevStepRelation")
  
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // Indexes
  @@index([chainId])
  @@index([roleId])
  @@index([chainId, roleId])
}

model FlowTransition {
  id         String              @id @default(cuid())
  fromStepId String
  toStepId   String
  condition  TransitionCondition @default(SUCCESS)
  
  // Relations
  fromStep FlowStep @relation("NextStepRelation", fields: [fromStepId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  toStep   FlowStep @relation("PrevStepRelation", fields: [toStepId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  
  createdAt DateTime @default(now()) @db.Timestamptz(3)

  // Indexes
  @@index([fromStepId])
  @@index([toStepId])
  @@index([fromStepId, condition])
  @@unique([fromStepId, toStepId, condition])
}



model Campaign {
  id        String  @id @default(cuid())
  name      String  @db.VarChar(255)
  companyId String
  adminId   String
  teamId    String?
  status     String   @default("active") @db.VarChar(50) // active, deleted, archived
  deletedAt  DateTime? @db.Timestamptz(3) //  Soft delete timestamp
  deletedBy  String?  // Who deleted it (Employee ID)
  uploadSessions UploadSession[]

  // Relations
  company     Company              @relation(fields: [companyId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  admin       Employee             @relation(fields: [adminId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  team        Team?                @relation(fields: [teamId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  assignments CampaignAssignment[]
  flows       CampaignFlow[]
  schedules   CampaignSchedule[]
  videos      Video[]  
  documents   Document[]
  videoCollections VideoCollection[]

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // Indexes
  @@index([companyId])
  @@index([adminId])
  @@index([teamId])
  @@index([companyId, name])
  @@index([companyId, updatedAt(sort: Desc)])
}

model CampaignAssignment {
  id         String   @id @default(cuid())
  campaignId String
  employeeId String
  roleId     String
  note       String?  @db.Text
  joinedAt   DateTime @default(now()) @db.Timestamptz(3)
  
  // Relations
  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  role     Role     @relation(fields: [roleId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // Indexes
  @@index([campaignId])
  @@index([employeeId])
  @@index([roleId])
  @@index([campaignId, roleId])
  @@unique([campaignId, employeeId])
}

model CampaignFlow {
  id          String  @id @default(cuid())
  campaignId  String
  flowChainId String
  isDefault   Boolean @default(false)
  
  // Relations
  campaign  Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  flowChain FlowChain @relation(fields: [flowChainId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // Indexes
  @@index([campaignId])
  @@index([flowChainId])
  @@index([campaignId, isDefault])
  @@unique([campaignId, flowChainId])
}

model CampaignSchedule {
  id         String   @id @default(cuid())
  campaignId String
  roleId     String
  title      String?  @db.VarChar(500)
  startDate  DateTime @db.Timestamptz(3)
  endDate    DateTime @db.Timestamptz(3)
  color      String?  @db.VarChar(50)
  createdBy  String?
  
  // Relations
  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  role     Role     @relation(fields: [roleId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // Indexes - crucial for calendar queries
  @@index([campaignId])
  @@index([roleId])
  @@index([campaignId, startDate, endDate])
  @@index([startDate, endDate])
  @@index([campaignId, roleId])
}

// ===================== VIDEO MODELS =====================


model Video {
  id              String   @id @default(cuid())
  title           String   @db.VarChar(500)
  filename        String   @db.VarChar(255)
  originalSize    BigInt
  duration        Int?     // seconds
  resolution      String?  @db.VarChar(20) // e.g., "1920x1080"
  fps             Int?
  codec           String?  @db.VarChar(50)
  status          String   @default("uploading") @db.VarChar(50) // uploading, processing, ready, error, archived
  
  // R2 Storage
  r2Key           String   @db.VarChar(500)
  r2Bucket        String   @db.VarChar(255)
  
  // Cloudflare Stream
  streamId        String?  @unique @db.VarChar(255)
  playbackUrl     String?  @db.Text
  thumbnailUrl    String?  @db.Text
  
  // Metadata
  tags            String[] @default([])
  metadata        Json     @default("{}")
  
  // Relations - Using Campaign as Project
  campaignId      String?   // <-- Links to Campaign (your "project")
  campaign        Campaign? @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  uploadSession   UploadSession?
  streamQueue     StreamQueue?
  compressionJobs CompressionJob[]
  comments        Comment[]
  shareSettings   VideoShare?
  views           VideoView[]
  heatmaps        VideoHeatmap[] // Direct relation for aggregate queries
  videoCTA        VideoCTA[]
  description     VideoDescription?
  uploadedBy      String
  uploader        Employee @relation("VideoUploader", fields: [uploadedBy], references: [id], onDelete: Restrict)
  collections     VideoCollectionItem[]
  socialPosts     SocialPost[]
  companyId       String?
  company         Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Versions
  currentVersion  Int      @default(1)
  versions        VideoVersion[]
  
  createdAt       DateTime @default(now()) @db.Timestamptz(3)
  updatedAt       DateTime @updatedAt @db.Timestamptz(3)

  @@index([campaignId])  // <-- Index on campaignId
  @@index([uploadedBy])
  @@index([status])
  @@index([campaignId, status])
  @@index([streamId])
  @@index([createdAt(sort: Desc)])
  @@index([companyId])
  @@index([companyId, campaignId])

}


model VideoVersion {
  id              String   @id @default(cuid())
  videoId         String
  version         Int
  
  // File info
  r2Key           String   @db.VarChar(500)
  fileSize        BigInt
  status          String   @db.VarChar(50) // uploading, ready, archived, deleted
  
  // Version metadata
  versionNote     String?  @db.Text
  isActive        Boolean  @default(false)
  
  // Cloudflare Stream (optional, for this version)
  streamId        String?  @db.VarChar(255)
  playbackUrl     String?  @db.Text
  thumbnailUrl    String?  @db.Text

  // Who created this version
  uploadedBy      String
  uploader        Employee @relation("VersionUploader", fields: [uploadedBy], references: [id], onDelete: Restrict)
  
  video           Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now()) @db.Timestamptz(3)

  @@index([videoId])
  @@index([videoId, version])
  @@index([videoId, isActive])
  @@unique([videoId, version])
}




// ===================== PERMISSION COMBO MODELS =====================

model PermissionCombo {
  id          String  @id @default(cuid())
  name        String  @db.VarChar(255)
  description String? @db.Text
  companyId   String
  
  // Relations
  company     Company           @relation(fields: [companyId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  permissions ComboPermission[]
  
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  // Indexes
  @@index([companyId])
  @@index([companyId, name])
  @@unique([name, companyId])
}

model ComboPermission {
  comboId      String
  permissionId String
  
  // Relations
  combo      PermissionCombo @relation(fields: [comboId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  permission Permission      @relation(fields: [permissionId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  
  createdAt DateTime @default(now()) @db.Timestamptz(3)

  @@id([comboId, permissionId])
  @@index([comboId])
  @@index([permissionId])
}


// ===================== UPLOAD SESSION MODEL =====================

model UploadSession {
  id          String   @id @default(cuid())
  
  // R2 Multipart Upload Info
  uploadId    String   @unique @db.Text  // R2's multipart upload ID
  key         String   @db.VarChar(500)          // R2 object key path
  
  // File Information
  fileName    String   @db.Text
  fileSize    BigInt                             // Total file size in bytes
  fileType    String   @db.Text          // MIME type (e.g., "video/mp4")
  
  // Upload Progress
  totalParts     Int                             // Number of parts for multipart upload
  uploadedParts  Json     @default("[]")         // Array of completed part numbers [1, 2, 3]
  metadata    String      @default("")
  // Status Tracking
  status      String   @default("IN_PROGRESS") @db.Text
  // Possible values: IN_PROGRESS, COMPLETED, FAILED, ABORTED, EXPIRED
  
  // Relations
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  uploadedBy  String
  uploader    Employee @relation("UploadSessions", fields: [uploadedBy], references: [id], onDelete: Restrict)
  
  // Video Link (after completion)
  videoId     String?   @unique
  video       Video?    @relation(fields: [videoId], references: [id], onDelete: SetNull)

  documentId  String?   @unique
  document    Document? @relation(fields: [documentId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(3)
  completedAt DateTime? @db.Timestamptz(3)
  expiresAt   DateTime  @db.Timestamptz(3)  // Auto-cleanup after 24 hours
  
  // Indexes for Performance
  @@index([campaignId])
  @@index([uploadedBy])
  @@index([status])
  @@index([expiresAt])
  @@index([uploadId])
  @@index([status, createdAt])
  @@map("upload_sessions")
}

// ===================== STREAMQUEUE MODEL =====================

model StreamQueue {
  id          String   @id @default(cuid())
  videoId     String   @unique
  video       Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  r2Key       String   @db.VarChar(500)
  status      String   @default("PENDING") @db.VarChar(50) // PENDING, PROCESSING, COMPLETED, FAILED
  streamId    String?  @db.VarChar(255) // Cloudflare Stream ID when ready
  attempts    Int      @default(0)
  maxAttempts Int      @default(3)
  lastError   String?  @db.Text
  priority    String   @default("NORMAL") @db.VarChar(50) // LOW, NORMAL, HIGH
  
  createdAt   DateTime @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime @updatedAt @db.Timestamptz(3)
  startedAt   DateTime? @db.Timestamptz(3)
  completedAt DateTime? @db.Timestamptz(3)
  
  @@index([status])
  @@index([videoId])
  @@index([status, priority, createdAt])
}

model CompressionJob {
  id                   String   @id @default(cuid())
  videoId              String
  video                Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  metadata             Json     @default("{}") 
  // Job settings
  quality              String   @db.VarChar(50) // low, medium, high, source
  codec                String   @db.VarChar(50) // h264, h265, vp9, av1
  targetBitrate        Int?     // kbps
  targetResolution     String?  @db.VarChar(20) // e.g., "1920x1080"
  priority             String   @default("NORMAL") @db.VarChar(50) // LOW, NORMAL, HIGH
  
  // Job status
  status               String   @default("PENDING") @db.VarChar(50) // PENDING, PROCESSING, COMPLETED, FAILED, ABORTED
  progress             Int      @default(0) // 0-100
  
  // Output info
  outputR2Key          String?  @db.VarChar(500)
  outputSize           BigInt?
  estimatedOutputSize  BigInt?
  
  // Error tracking
  attempts             Int      @default(0)
  maxAttempts          Int      @default(3)
  lastError            String?  @db.Text
  errorMessage         String?  @db.Text
  
  // Timing
  estimatedDuration    Int?     // seconds
  createdAt            DateTime @default(now()) @db.Timestamptz(3)
  updatedAt            DateTime @updatedAt @db.Timestamptz(3)
  startedAt            DateTime? @db.Timestamptz(3)
  completedAt          DateTime? @db.Timestamptz(3)
  
  // Who requested
  requestedBy          String
  requester            Employee @relation("CompressionRequests", fields: [requestedBy], references: [id], onDelete: Restrict)
  
  @@index([videoId])
  @@index([status])
  @@index([requestedBy])
  @@index([status, priority, createdAt])
}

model Comment {
  id          String        @id @default(cuid())
  videoId     String
  employeeId  String?
  content     String        @db.Text
  timestamp   Int?          // Video timestamp in seconds (null for general comments)
  status      CommentStatus @default(OPEN)
  parentId    String?       // For replies
  
  // Relations
  video       Video         @relation(fields: [videoId], references: [id], onDelete: Cascade)
  employee    Employee?      @relation("VideoComments", fields: [employeeId], references: [id], onDelete: Restrict)
  parent      Comment?      @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     Comment[]     @relation("CommentReplies")
  versionNumber Int?
  priority    CommentPriority @default(NONE)
  guestName   String?   
  createdAt   DateTime      @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime      @updatedAt @db.Timestamptz(3)
  resolvedAt  DateTime?     @db.Timestamptz(3)
  resolvedBy  String?
  resolver    Employee?     @relation("CommentResolver", fields: [resolvedBy], references: [id], onDelete: SetNull)
  
  @@index([videoId])
  @@index([employeeId])
  @@index([parentId])
  @@index([videoId, status])
  @@index([videoId, createdAt(sort: Desc)])
}


model VideoShare {
  id            String     @id @default(uuid()) // This UUID is the unique link token
  videoId       String     @unique
  video         Video      @relation(fields: [videoId], references: [id],onDelete: Cascade) 
  
  accessType    AccessType @default(PUBLIC)
  passwordHash  String?    
  
  allowComments Boolean    @default(true)
  allowDownload Boolean    @default(false)
  
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}

// ===================== ANALYTICS MODELS =====================

model VideoView {
  id          String   @id @default(cuid())
  videoId     String
  video       Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  // Viewer Identity
  viewerId    String?  // If logged in (Employee ID)
  viewerEmail String?  // If identified via unique link (?email=...)
  anonymousId String?  // Fingerprint/Cookie ID for anonymous users
  
  // Session Data
  ipAddress   String?  @db.VarChar(45)
  userAgent   String?  @db.Text
  referer     String?  @db.Text
  deviceType  String?  @db.VarChar(50) // mobile, desktop, tablet
  browser     String?  @db.VarChar(50)
  os          String?  @db.VarChar(50)
  location    String?  @db.VarChar(100) // City, Country (via IP lookup)
  
  // Engagement Metrics
  watchDuration Int      @default(0) // Total seconds watched
  percentage    Float    @default(0) // 0.0 to 100.0
  completed     Boolean  @default(false)
  
  // Heatmap Relation (1-to-many because one view generates many heatmap points)
  heatmaps    VideoHeatmap[]

  createdAt   DateTime @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime @updatedAt @db.Timestamptz(3)

  @@index([videoId])
  @@index([viewerEmail])
  @@index([createdAt])
}

model VideoHeatmap {
  id          String    @id @default(cuid())
  viewId      String
  view        VideoView @relation(fields: [viewId], references: [id], onDelete: Cascade)
  
  videoId     String
  video       Video     @relation(fields: [videoId], references: [id], onDelete: Cascade)

  // Segment Watched
  startTime   Int       // Seconds
  endTime     Int       // Seconds
  
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)

  @@index([viewId])
  @@index([videoId])
}

model VideoCTA {
  id          String   @id @default(cuid())
  videoId     String
  video       Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  type        String   // 'BUTTON', 'FORM', 'LINK'
  text        String   @db.VarChar(100)
  url         String?  @db.Text
  time        Int      // Seconds to appear (or -1 for post-roll)
  
  // Styling
  color       String?  @default("#3b82f6")
  position    String?  @default("center") // 'top-right', 'center', etc.
  
  // Tracking
  clicks      Int      @default(0)
  
  createdAt   DateTime @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime @updatedAt @db.Timestamptz(3)

  @@index([videoId])
}
model VideoDescription {
  id          String   @id @default(cuid())
  videoId     String   @unique
  video       Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  content     String   @db.Text
  chapters    Json?    // Store parsed chapters: [{ time: 0, title: "Intro" }]
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  @@index([videoId])
}


model VideoCollection {
  id            String   @id @default(uuid()) // This UUID serves as the share token
  name          String   @db.VarChar(255)
  description   String?  @db.Text
  
  // Ownership
  createdBy     String
  creator       Employee @relation("CollectionCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Optional: Link to campaign if sharing entire campaign videos
  campaignId    String?
  campaign      Campaign? @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  // Relations
  videos        VideoCollectionItem[]
  shareSettings CollectionShare?
  
  createdAt     DateTime @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime @updatedAt @db.Timestamptz(3)
  
  @@index([companyId])
  @@index([createdBy])
  @@index([campaignId])
}

model VideoCollectionItem {
  id           String          @id @default(cuid())
  collectionId String
  collection   VideoCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  
  videoId      String
  video        Video           @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  order        Int             @default(0) // For custom ordering
  
  addedAt      DateTime        @default(now()) @db.Timestamptz(3)
  
  @@unique([collectionId, videoId]) // Prevent duplicate videos in same collection
  @@index([collectionId])
  @@index([videoId])
  @@index([collectionId, order]) // For ordered retrieval
}

// Share settings for collections
model CollectionShare {
  id            String          @id @default(uuid()) // Additional token if needed
  collectionId  String          @unique
  collection    VideoCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  
  accessType    AccessType      @default(PUBLIC)
  passwordHash  String?
  
  allowComments Boolean         @default(true)
  allowDownload Boolean         @default(false)
  
  expiresAt     DateTime?       @db.Timestamptz(3) // Optional expiration
  
  createdAt     DateTime        @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime        @updatedAt @db.Timestamptz(3)
}

// ===================== LATE API INTEGRATION MODELS =====================

model LateProfile {
  id          String   @id @default(cuid())
  lateId      String   @unique @db.VarChar(255) // prof_abc123 from Late API
  name        String   @db.VarChar(255)
  description String?  @db.Text
  companyId   String   @unique  // ONE-TO-ONE relationship
  
  // Relations
  company        Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  socialAccounts SocialAccount[]
  
  createdAt   DateTime @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime @updatedAt @db.Timestamptz(3)
  
  @@index([lateId])
}

model SocialAccount {
  id            String   @id @default(cuid())
  profileId     String
  accountId     String    @default("")
  companyId     String   // Direct relation to Company
  platform      SocialPlatform
  username      String   @db.VarChar(255)
  displayName   String?  @db.VarChar(255)
  avatarUrl     String?  @db.Text
  isActive      Boolean  @default(true)
  
  // Relations
  profile       LateProfile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  company       Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  posts         SocialPost[]  // All posts (scheduled + published history)
  
  createdAt     DateTime @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime @updatedAt @db.Timestamptz(3)
  
  @@index([profileId])
  @@index([companyId])
  @@index([platform])
  @@index([companyId, platform])
  @@unique([profileId, platform]) // One account per platform per profile
}

model SocialPost {
  id              String      @id @default(cuid())
  companyId       String      // Direct relation to Company for faster queries
  socialAccountId String
  videoId         String?     // Link to Video model (optional for text-only posts)
  
  // Post content
  content         String      @db.Text
  caption         String?     @db.Text  // Platform-specific caption/description
  
  // Scheduling
  scheduledAt     DateTime?   @db.Timestamptz(3)  // Null if published immediately
  timezone        String      @default("UTC") @db.VarChar(100)
  status          PostStatus  @default(DRAFT)
  
  // Late API tracking
  latePostId      String?     @unique @db.VarChar(255) // post_123abc from Late
  
  // Media attachments (if not using Video relation)
  mediaUrls       String[]    @default([])
  
  // Platform-specific config (hashtags, mentions, etc.)
  platformConfig  Json?       @default("{}")
  
  // Relations
  company         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  socialAccount   SocialAccount @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)
  video           Video?        @relation(fields: [videoId], references: [id], onDelete: SetNull)
  
  // Analytics & Tracking
  publishedAt     DateTime?   @db.Timestamptz(3)
  views           Int         @default(0)
  likes           Int         @default(0)
  comments        Int         @default(0)
  shares          Int         @default(0)
  
  // Error handling
  error           String?     @db.Text
  retryCount      Int         @default(0)
  
  createdAt       DateTime    @default(now()) @db.Timestamptz(3)
  updatedAt       DateTime    @updatedAt @db.Timestamptz(3)
  
  @@index([companyId])
  @@index([socialAccountId])
  @@index([videoId])
  @@index([status])
  @@index([scheduledAt])
  @@index([publishedAt])
  @@index([companyId, status])
  @@index([companyId, publishedAt(sort: Desc)])
  @@index([socialAccountId, status])
  @@index([socialAccountId, publishedAt(sort: Desc)])
  @@index([videoId, publishedAt(sort: Desc)])
}

model ConnectionToken {
  id          String   @id @default(cuid())
  token       String   @unique @default(cuid())
  companyId   String
  platform    String
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  
  @@index([token])
  @@index([companyId])
}

// ===================== Notifications Model =====================


model NotificationPreference {
  id          String   @id @default(cuid())
  companyId   String   @unique

  emailEnabled Boolean @default(true)
  slackEnabled Boolean @default(false)
  teamsEnabled Boolean @default(false)

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
}
model SlackIntegration {
  id          String   @id @default(cuid())
  companyId   String   @unique

  slackTeamId String   @db.VarChar(50)
  botToken    String   @db.Text          // ENCRYPTED
  channelId   String   @db.VarChar(50)    // Where notifications go
  channelName String?  @db.VarChar(255)

  installedAt DateTime @default(now()) @db.Timestamptz(3)
  isActive    Boolean  @default(true)

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([slackTeamId])
}
model TeamsIntegration {
  id          String   @id @default(cuid())
  companyId   String   @unique

  webhookUrl  String   @db.Text     // ENCRYPTED
  channelName String?  @db.VarChar(255)

  installedAt DateTime @default(now()) @db.Timestamptz(3)
  isActive    Boolean  @default(true)

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
}
model EmailIntegration {
  id          String   @id @default(cuid())
  companyId   String   @unique

  fromEmail   String   @db.VarChar(255)
  replyTo     String?  @db.VarChar(255)
  isActive    Boolean  @default(true)

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model NotificationLog {
  id               String   @id @default(cuid())
  companyId        String
  notificationType String   @db.VarChar(100)
  channels         String   @db.VarChar(255) // comma-separated
  success          Boolean
  error            String?  @db.Text
  metadata         Json?
  
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@index([companyId])
  @@index([notificationType])
  @@index([createdAt(sort: Desc)])
}

model Document {
  id              String   @id @default(cuid())
  title           String   @db.VarChar(500)
  filename        String   @db.VarChar(255)
  fileSize        BigInt

  documentType    DocumentType // High-level category
  mimeType        String   @db.VarChar(100) // application/pdf, image/png, text/plain, etc.
  
  // Document-specific
  pageCount       Int?     // For PDFs
  
  status          String   @default("ready") @db.VarChar(50) // ready, archived, deleted
  
  // R2 Storage
  r2Key           String   @db.VarChar(500)
  r2Bucket        String   @db.VarChar(255)
  
  // Preview/Thumbnail
  thumbnailUrl    String?  @db.Text
  
  tags            String[] @default([])
  metadata        Json     @default("{}")
  
  // Relations
  campaignId      String?
  campaign        Campaign? @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  companyId       String?
  company         Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  uploadedBy      String
  uploader        Employee @relation("DocumentUploader", fields: [uploadedBy], references: [id], onDelete: Restrict)
  
  uploadSession   UploadSession?
  comments        DocumentComment[]
  shareSettings   DocumentShare?
  versions        DocumentVersion[]
  
  currentVersion  Int      @default(1)
  createdAt       DateTime @default(now()) @db.Timestamptz(3)
  updatedAt       DateTime @updatedAt @db.Timestamptz(3)

  @@index([campaignId])
  @@index([uploadedBy])
  @@index([status])
  @@index([mimeType])
  @@index([campaignId, status]) 
  @@index([documentType])  
  @@index([campaignId, documentType])
  @@index([companyId])
  @@index([companyId, campaignId])
  @@index([companyId, status])

  @@index([createdAt(sort: Desc)])
}

model DocumentVersion {
  id              String   @id @default(cuid())
  documentId      String
  version         Int
  
  // File info
  r2Key           String   @db.VarChar(500)
  fileSize        BigInt
  status          String   @db.VarChar(50) // ready, archived, deleted
  
  // Version metadata
  versionNote     String?  @db.Text
  isActive        Boolean  @default(false)
  
  // Who created this version
  uploadedBy      String
  uploader        Employee @relation("DocumentVersionUploader", fields: [uploadedBy], references: [id], onDelete: Restrict)
  
  document        Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now()) @db.Timestamptz(3)

  @@index([documentId])
  @@index([documentId, version])
  @@index([documentId, isActive])
  @@unique([documentId, version])
}
model DocumentComment {
  id          String        @id @default(cuid())
  documentId  String
  employeeId  String?
  content     String        @db.Text
  status      CommentStatus @default(OPEN)
  parentId    String?       // For replies
  
  // Relations
  document    Document      @relation(fields: [documentId], references: [id], onDelete: Cascade)
  employee    Employee?     @relation("DocumentComments", fields: [employeeId], references: [id], onDelete: Restrict)
  parent      DocumentComment? @relation("DocumentCommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     DocumentComment[] @relation("DocumentCommentReplies")
  
  versionNumber Int?
  priority    CommentPriority @default(NONE)
  guestName   String?
  resolution  String?   
  createdAt   DateTime      @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime      @updatedAt @db.Timestamptz(3)
  resolvedAt  DateTime?     @db.Timestamptz(3)
  resolvedBy  String?
  resolver    Employee?     @relation("DocumentCommentResolver", fields: [resolvedBy], references: [id], onDelete: SetNull)
  
  @@index([documentId])
  @@index([employeeId])
  @@index([parentId])
  @@index([documentId, status])
  @@index([documentId, createdAt(sort: Desc)])
}
model DocumentShare {
  id            String     @id @default(uuid()) // This UUID is the unique link token
  documentId    String     @unique
  document      Document   @relation(fields: [documentId], references: [id], onDelete: Cascade) 
  
  accessType    AccessType @default(PUBLIC)
  passwordHash  String?    
  
  allowComments Boolean    @default(true)
  allowDownload Boolean    @default(true) // Documents typically allow download
  
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}

//  model for granular access control on campaign-less assets
model AssetVisibility {
  id          String          @id @default(cuid())
  
  // Polymorphic asset reference
  assetId     String
  assetType   AssetType
  
  scope       VisibilityScope
  
  // Relations (optional based on scope)
  roleId      String?
  role        Role?     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  employeeId  String?
  employee    Employee? @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  companyId   String
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(3)
  
  @@index([assetId, assetType])
  @@index([companyId])
  @@index([roleId])
  @@index([employeeId])
  @@index([companyId, scope])
  @@unique([assetId, assetType, roleId, employeeId])
}
